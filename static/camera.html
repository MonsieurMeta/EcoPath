<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoPath - Main</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <iframe src="music.html" style="display:none;" allow="autoplay"></iframe>
    <style>
        /* CSS comes here */
        #video {
            border: 1px solid black;
            width: 320px;
            height: 240px;
        }
    
        #photo {
            border: 1px solid black;
            width: 320px;
            height: 240px;
        }
    
        #canvas {
            display: none;
        }
    
        .camera {
            width: 340px;
            display: inline-block;
        }
    
        .output {
            width: 340px;
            display: inline-block;
        }
    
        #startbutton {
            display: block;
            position: relative;
            margin-left: auto;
            margin-right: auto;
            bottom: 36px;
            padding: 5px;
            background-color: #6a67ce;
            border: 1px solid rgba(255, 255, 255, 0.7);
            font-size: 14px;
            color: rgba(255, 255, 255, 1.0);
            cursor: pointer;
        }
    
        .contentarea {
            font-size: 16px;
            font-family: Arial;
            text-align: center;
        }
        </style>
        <title>My Favorite Sport</title>

        <script  type="text/javascript">
       function toggle(id) {
                    //0 = photo, 1 = video
        
                    if (id == 0) {
                        document.getElementById("pDiv").style.display = "";
                        document.getElementById("vDiv").style.display = "none";
        
                    } else {
                        document.getElementById("pDiv").style.display = "none";
                        document.getElementById("vDiv").style.display = "";
        
                    }
                }
            /* JS comes here */
            (function() {
        
                var width = 320; // We will scale the photo width to this
                var height = 0; // This will be computed based on the input stream
        
                var streaming = false;
        
                var video = null;
                var canvas = null;
                var photo = null;
                var startbutton = null;
        

                function startup() {
                    video = document.getElementById('video');
                    canvas = document.getElementById('canvas');
                    photo = document.getElementById('photo');
                    startbutton = document.getElementById('startbutton');
        
                    navigator.mediaDevices.getUserMedia({
                            video: true,
                            audio: false
                        })
                        .then(function(stream) {
                            video.srcObject = stream;
                            video.play();
                        })
                        .catch(function(err) {
                            console.log("An error occurred: " + err);
                        });
        
                    video.addEventListener('canplay', function(ev) {
                        if (!streaming) {
                            height = video.videoHeight / (video.videoWidth / width);
        
                            if (isNaN(height)) {
                                height = width / (4 / 3);
                            }
        
                            video.setAttribute('width', width);
                            video.setAttribute('height', height);
                            canvas.setAttribute('width', width);
                            canvas.setAttribute('height', height);
                            streaming = true;
                        }
                    }, false);
        
                    startbutton.addEventListener('click', function(ev) {
                        takepicture();
                        ev.preventDefault();
                    }, false);
        
                    clearphoto();
                }
        
        
                function clearphoto() {
                    var context = canvas.getContext('2d');
                    context.fillStyle = "#AAA";
                    context.fillRect(0, 0, canvas.width, canvas.height);
        
                    var data = canvas.toDataURL('image/png');
                    photo.setAttribute('src', data);
                }
               const url = 'http://127.0.0.1:8000/get_picture_description';
                
               function takepicture() {
                    var context = canvas.getContext('2d');
                    if (width && height) {
                        canvas.width = width;
                        canvas.height = height;
                        context.drawImage(video, 0, 0, width, height);
        
                        var data = canvas.toDataURL('image/png');
                        var post_data={
                            "user_id": 1,
                     "base64_image": data,
                     "funct": "rate"
                        };
                      postData(url, post_data)
                            .then(data => {
                                var result= JSON.stringify(data)
                                console.log('Success:',result);
        
                                // Update the points circle
        
                                const pointsElement = document.getElementById('result');
                        if (pointsElement) {
                            pointsElement.textContent = result; // 
                        }
                                
                            })
                            .catch((error) => {
                                console.error('Error:', error);
                            });
        
                        console.log(data); 
                        photo.setAttribute('src', data);
                    } else {
                        clearphoto();
                    }
                    toggle(0);
                }
         
        
        async function postData(url = '', data = {}) {
            // Default options are marked with *
            const response = await fetch(url, {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *client
                body: JSON.stringify(data) // body data type must match "Content-Type" header
            });
            return await response.json(); // parses JSON response into native JavaScript objects
        }
                window.addEventListener('load', startup, false);
            })();
            </script>
        
</head>

<body>
    <header>
        <i class="fas fa-cog settings-icon" onclick="window.location.href='settings.html';"></i>
        <div class="logo">
            <img src="ecopath.png" style="width: 200px; margin:0;">
        </div>
    </header>
 


<div class="contentarea">

    <div id="vDiv" class="camera">
        <video id="video">Video stream not available.</video>
    </div>
    <div><button id="startbutton">Take photo</button></div>
    <canvas id="canvas"></canvas>
    <div id="pDiv" class="output" onclick="toggle(1)" style="display:none;">
        <img id="photo" alt="The screen capture will appear in this box.">
    </div>
</div>
    <main>
        <span id="result"></span>
        <h2>EcoPoints</h2>
        <div class="points-circle">
            <span id="points"> </span> 
        </div>        
        <button class="earn-more"   onClick="takePicture()">
            take picture
        </button>
        
        <div id="points-popup" class="popup">
            <div class="popup-content">
                <h3>test</h3>
                <ul>
                    <li>were supposed to take a picture heres</li>
                </ul>
            </div>
        </div>
        
        <div class="goal-progress">
            <i class="fas fa-bullseye goal-icon"></i>
            <div class="progress-bar">
                <div class="progress" id="goal-progress"></div>
            </div>
            <p id="goal-progress-text">0%</p> <!-- This will be updated by JavaScript -->
        </div>

        <!-- Tip Box Feature -->
        <div class="tip-box">
            <h3>Eco Tip</h3>
            <p>Save water by turning off the tap while brushing your teeth. Every drop counts!</p>
        </div>
    </main>

    <nav class="bottom-nav">
        <a href="tracker.html" class="nav-item">
            <i class="fas fa-route"></i>
            <span>Tracker</span>
        </a>
        <a href="goal.html" class="nav-item">
            <i class="fas fa-bullseye"></i>
            <span>Goals</span>
        </a>
        <a href="main.html" class="nav-item main-nav">
            <i class="fas fa-star"></i>
            <span>Points</span>
        </a>
        <a href="camera.html" class="nav-item">
            <i class="fas fa-camera"></i>
            <span>Camera</span>
        </a>
        <a href="garden.html" class="nav-item">
            <i class="fas fa-seedling"></i>
            <span>Garden</span>
        </a>
    </nav>

</body>
</html>
